<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Pengiriman â€“ Logistics Azka</title>
    <link rel="icon" type="image/x-icon" href="/static/icon/icon.png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <!-- BOOTSTRAP -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- MODERN FONT -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- ICONS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

    <style>
         :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --accent-color: #6366f1;
            --text-primary: #1f2937;
            --text-muted: #6b7280;
            --bg-light: #f8fafc;
            --bg-card: #ffffff;
            --shadow-light: 0 4px 20px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 8px 32px rgba(0, 0, 0, 0.12);
            --border-radius: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            background: var(--bg-light);
            font-family: 'Inter', sans-serif;
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        /* SIDEBAR */
        .sidebar {
            width: 280px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(0, 0, 0, 0.05);
            position: fixed;
            top: 0;
            left: 0;
            padding: 40px 0 20px;
            box-shadow: var(--shadow-light);
            overflow-y: auto;
            overflow-x: hidden;
            animation: slideInLeft 0.8s ease-out;
            z-index: 1000;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-color) transparent;
        }

        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 10px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar h4 {
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            letter-spacing: 0.5px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 40px;
            animation: fadeInUp 1s ease;
        }

        .sidebar a i {
            font-size: 20px;          /* Lebarkan ikon */
            width: 45px;              /* Tambahkan ruang khusus ikon */
            text-align: center;       /* Biar rapi di tengah */
            flex-shrink: 0;           /* Jangan mengecil */
        }


        .sidebar a {
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 24px;
            margin: 8px 20px;
            color: var(--text-muted);
            font-size: 16px;
            font-weight: 500;
            text-decoration: none;
            border-radius: var(--border-radius);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .sidebar a::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--primary-gradient);
            transition: left 0.4s ease;
            z-index: -1;
        }

        .sidebar a:hover::before,
        .sidebar a.active::before {
            left: 0;
        }

        .sidebar a:hover,
        .sidebar a.active {
            color: #ffffff;
            transform: translateX(8px);
            box-shadow: var(--shadow-hover);
        }

        .sidebar a.active {
            font-weight: 600;
        }

        /* ANIMATIONS */
        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* MAIN CONTENT */
        .content {
            margin-left: 280px;
            padding: 40px;
            min-height: 100vh;
        }

        /* TOPBAR */
        .topbar {
            background: var(--bg-card);
            padding: 24px 32px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            animation: fadeInUp 0.6s ease;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .topbar h4 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .topbar p {
            font-size: 14px;
            color: var(--text-muted);
            margin: 0;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        #map {
            width: 100%;
            min-height: 400px;
        }

        .user-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary-gradient);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 22px;
            font-weight: 700;
            box-shadow: var(--shadow-light);
            transition: var(--transition);
        }

        .user-avatar:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-hover);
        }

        .dropdown-menu {
            border-radius: var(--border-radius);
            border: none;
            box-shadow: var(--shadow-hover);
            padding: 12px;
            animation: fadeIn 0.2s ease;
        }

        .dropdown-item {
            border-radius: 8px;
            transition: var(--transition);
            font-weight: 500;
        }

        .dropdown-item:hover {
            background: var(--primary-gradient);
            color: white;
        }

        /* METRIC CARDS */
        .card-metric {
            background: var(--bg-card);
            padding: 32px;
            height: 140px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .card-metric::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: var(--primary-gradient);
            opacity: 0.05;
            border-radius: 50%;
            transform: scale(0);
            transition: transform 0.5s ease;
        }

        .card-metric:hover::before {
            transform: scale(1);
        }

        .card-metric:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-hover);
        }

        .metric-icon {
            position: absolute;
            top: 20px;
            right: 24px;
            font-size: 32px;
            opacity: 0.6;
            transition: var(--transition);
        }

        .card-metric:hover .metric-icon {
            opacity: 0.8;
            transform: scale(1.1);
        }

        .card-metric h6 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-muted);
            margin: 0;
            z-index: 1;
        }

        .card-metric h2 {
            font-size: 36px;
            font-weight: 700;
            margin: 0;
            z-index: 1;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* CHART CONTAINER */
        .chart-container {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            padding: 32px;
            box-shadow: var(--shadow-light);
            margin-top: 24px;
            transition: var(--transition);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .chart-container:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
        }

        .chart-container h5 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 24px;
            color: var(--text-primary);
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                padding: 20px 0;
            }

            .content {
                margin-left: 0;
                padding: 20px;
            }

            .topbar {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }

            .card-metric {
                height: auto;
                padding: 24px;
            }

            .row .col-md-3 {
                margin-bottom: 16px;
            }
        }

        /* TABLE CARD */
        .table-card {
            background: var(--bg-card);
            padding: 32px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            border: 1px solid rgba(0,0,0,0.04);
            transition: var(--transition);
        }

        .table-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
        }

        
        /* POPUP BACKDROP */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(3px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            transition: opacity .3s ease;
        }

        /* TAMPIL OTOMATIS SAAT TARGET */
        .modal-overlay:target {
            display: flex;
            opacity: 1;
        }

        /* BOX POPUP */
        .modal-box {
            width: 800px;          /* LEBAR */
            max-width: 95%;
            max-height: 80vh;     /* BATAS TINGGI */
            overflow-y: auto;
            background: white;
            padding: 30px;
            border-radius: 18px;
            animation: popup .3s ease;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }

        @keyframes popup {
            from { transform: translateY(-20px); opacity: 0; }
            to   { transform: translateY(0); opacity: 1; }
        }

        .modal-box h4 {
            margin-bottom: 20px;
            font-weight: 700;
        }

        .modal-box input,
        .modal-box select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 12px;
            margin-top: 5px;
        }
        @media (max-width:768px) {
            .modal-box {
                width: 95%;
                max-height: 75vh;
                padding: 20px;
            }
        }

             @media (max-width: 768px) {

            body {
                padding-bottom: 80px;
            }

            /* HIDE SIDEBAR */
            .sidebar {
                display: none;
            }

            /* FULL CONTENT */
            .content {
                margin-left: 0;
                padding: 16px;
            }

            /* TOPBAR */
            .topbar {
               display: flex;
                flex-direction: row !important;
                justify-content: space-between;
                align-items: center;
                gap: 10px;
            }

            .topbar h4 {
                font-size: 20px;
            }

            .topbar p {
                font-size: 12px;
            }

            /* Container row */
            .row.g-4 {
                margin-left: -6px;
                margin-right: -6px;
            }

            /* Bagi 2 kolom rata kiriâ€“kanan */
            .row.g-4 > .col-md-3 {
                flex: 0 0 50%;
                max-width: 50%;
                padding-left: 6px;
                padding-right: 6px;
            }

            /* Card lebih compact */
            .card-metric {
                padding: 18px 16px;
                height: auto;
                border-radius: 14px;
                text-align: left;
            }

            .card-metric h6 {
                font-size: 12px;
                margin-bottom: 6px;
            }

            .card-metric h2 {
                font-size: 22px;
                line-height: 1.2;
            }

            .metric-icon {
                font-size: 24px;
                top: 12px;
                right: 12px;
            }
        }

            /* CHART */
            .chart-container {
                padding: 20px;
            }

            /* ===== BOTTOM NAV ===== */
            .bottom-nav {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                height: 70px;
                background: rgba(255,255,255,0.95);
                backdrop-filter: blur(12px);
                display: flex;
                justify-content: space-around;
                align-items: center;
                border-top: 1px solid rgba(0,0,0,0.08);
                z-index: 3000;
            }

            .bottom-nav a {
                flex: 1;
                text-align: center;
                color: #6b7280;
                font-size: 11px;
                text-decoration: none;
            }

            .bottom-nav a i {
                font-size: 22px;
                display: block;
            }

            .bottom-nav a.active {
                color: #6366f1;
                font-weight: 600;
            }

            /* ===== MOBILE MENU (FULL SIDEBAR) ===== */
            .mobile-menu {
                position: fixed;
                bottom: -100%;
                left: 0;
                right: 0;
                height: 85vh;
                background: #fff;
                border-radius: 24px 24px 0 0;
                box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
                transition: 0.35s ease;
                z-index: 4000;
                padding: 20px;
            }

            .mobile-menu.show {
                bottom: 0;
            }

            .menu-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 16px;
            }

            .menu-grid a {
                background: #f8fafc;
                border-radius: 16px;
                padding: 16px 10px;
                text-align: center;
                font-size: 12px;
                color: #1f2937;
                text-decoration: none;
            }

            .menu-grid a i {
                font-size: 24px;
                display: block;
                margin-bottom: 6px;
                color: #6366f1;
            }
        
/* ================= TABLE MODERN ================= */
.table-custom {
    font-size: 14px;
    border-radius: 14px;
    overflow: hidden;
}

.table-custom thead th {
    background: #f1f5f9;
    font-weight: 600;
    font-size: 13px;
    color: #334155;
    text-align: center;
    vertical-align: middle;
}

.table-custom td {
    vertical-align: middle;
    padding: 12px;
    color: #1f2937;
}

.table-custom tbody tr:hover {
    background-color: #f8fafc;
}
@media (max-width: 768px) {

    .table-responsive-custom {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    .table-custom {
        font-size: 12px;
        min-width: 760px; /* penting: biar tidak gepeng */
    }

    .table-custom th,
    .table-custom td {
        padding: 8px 10px;
        white-space: nowrap;
    }

    /* Kolom deskripsi dipendekin */
    .table-custom td:nth-child(5) {
        max-width: 160px;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Aksi lebih rapih */
    .table-custom td:last-child {
        text-align: center;
    }

    .table-custom .btn {
        padding: 4px 8px;
        font-size: 12px;
    }
}
@media (max-width: 768px) {
    .table-custom thead th {
        position: sticky;
        top: 0;
        z-index: 2;
    }
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
}

@media (max-width:768px) {
    .form-grid {
        grid-template-columns: 1fr;
    }
}

    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <div class="sidebar">
        <h4>ðŸ“¦ Logistics</h4>
        <a href="/admin_dashboard_azka"><i class="bi bi-speedometer2"></i> Dashboard</a>
        <a href="/product_azka"><i class="bi bi-box-seam"></i> Data Barang</a>
        <a href="/activity_logs_azka"><i class="bi bi-clock-history"></i> Activity Logs</a>
        <a href="/admin_users_azka"><i class="bi bi-people"></i> Pengguna</a>
        <a href="/gudang_azka"><i class="bi bi-building"></i> Gudang</a>
        <a href="/shipment_azka"  class="active"><i class="bi bi-box-arrow-up"></i> Shipment</a>
         <a href="/laporan_azka"><i class="bi bi-bar-chart"></i> Laporan</a>
    </div>
    <!-- MOBILE FULL MENU --> 
    <div class="mobile-menu" id="mobileMenu">
        <div class="menu-header">
            <span>ðŸ“¦ Logistics Menu</span>
            <button id="closeMenu">&times;</button>
        </div>

        <div class="menu-grid">
            <a href="/admin_dashboard_azka"><i class="bi bi-speedometer2"></i>Dashboard</a>
            <a href="/product_azka"><i class="bi bi-box-seam"></i>Data Barang</a>
            <a href="/activity_logs_azka"><i class="bi bi-clock-history"></i>Activity Logs</a>
            <a href="/admin_users_azka"><i class="bi bi-people"></i>Pengguna</a>
            <a href="/gudang_azka"><i class="bi bi-building"></i>Gudang</a>
            <a href="/shipment_azka"><i class="bi bi-box-arrow-up"></i>Shipment</a>
           
             <a href="/laporan_azka"><i class="bi bi-bar-chart"></i> Laporan</a>
        </div>
    </div>

    <div class="content">

        <div class="topbar">
            <div>
                <h4>Data Pengiriman </h4>
                <p class="text-muted">Data Pengiriman â€¢ Sistem Manajemen Distribusi Logistik Barang</p>
            </div>

            <div class="dropdown">
                <button class="btn d-flex align-items-center gap-3" style="background:none;border:none;" data-bs-toggle="dropdown">
                    <div class="user-avatar">{{ username_azka[0]|upper }}</div>
                    <div class="text-start">
                        <strong>{{ username_azka }}</strong><br>
                        <small class="text-muted">Administrator</small>
                    </div>
                    <i class="bi bi-chevron-down"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">

                    <li><hr class="dropdown-divider"></li>
                
                    <li>
                        <a class="dropdown-item text-danger" href="/logout_azka">
                            <i class="bi bi-box-arrow-right me-2"></i> Logout
                        </a>
                    </li>
                </ul>
                
                
            </div>
        </div>

       <div class="table-responsive table-responsive-custom">
            <div class="d-flex justify-content-between mb-3">
                <h5><i class="bi bi-list-check me-2"></i>Data Pengiriman</h5>
            
                <a href="#add_product" class="btn btn-primary"
                   style="border-radius: 12px; padding: 8px 16px;">
                    <i class="bi bi-plus-circle me-1"></i> Tambah Pengiriman
                </a>
            </div>
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} d-flex align-items-center shadow-sm fade show mb-4"
                            style="border-radius: 14px; padding:14px; font-size:15px; background:white;">
                            
                            {% if category == 'success' %}
                                <i class="bi bi-check-circle-fill text-success fs-4 me-2"></i>
                            {% elif category == 'danger' %}
                                <i class="bi bi-x-circle-fill text-danger fs-4 me-2"></i>
                            {% elif category == 'warning' %}
                                <i class="bi bi-exclamation-triangle-fill text-warning fs-4 me-2"></i>
                            {% else %}
                                <i class="bi bi-info-circle-fill text-primary fs-4 me-2"></i>
                            {% endif %}

                            <div>{{ message }}</div>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
<table class="table table-hover table-bordered align-middle table-custom">
    <thead>
        <tr>
            <th>No</th>
            <th>No Resi</th>
            <th>Pengirim</th>
            <th>Penerima</th>
            <th>Gudang</th>
            <th>Kurir</th>
            <th>Status</th>
            <th>Dibuat</th>
            <th>Aksi</th>
        </tr>
    </thead>
    <tbody>
        {% for s in data_shipment_azka %}
        <tr>
            <td>{{ loop.index }}</td>
            <td><strong>{{ s.tracking_number_azka }}</strong></td>
            <td>{{ s.sender_name_azka }}</td>
            <td>
                {{ s.receiver_name_azka }}<br>
                <small class="text-muted">{{ s.receiver_address_azka }}</small>
            </td>
            <td>{{ s.origin_name }}</td>
            <td>{{ s.courier or '-' }}</td>
            <td>
                
                <span class="badge 
                    {% if s.status_azka == 'OUT_FOR_DELIVERY' %}bg-primary
                    {% elif s.status_azka == 'ARRIVED_AT_HUB' %}bg-warning
                    {% elif s.status_azka == 'DELIVERED' %}bg-success
                    {% else %}bg-secondary{% endif %}
                    mb-1 d-block">
                    {{ s.status_azka.replace('_',' ') }}
                </span>

    
            </td>

            </td>
            <td>{{ s.created_at_azka }}</td>
            <td>
                <form action="/shipment_delete_azka/{{ s.id_azka }}" method="POST"
                    onsubmit="return confirm('Yakin hapus shipment ini?')">

                    <button type="submit" class="btn btn-sm btn-danger mt-1">
                        <i class="bi bi-trash"></i>
                    </button>
                </form>
                <button type="button"
                    class="btn btn-sm btn-primary mt-1 w-100"
                    onclick='openTrackingModal(
                        {{ s.routes | tojson }},
                        "{{ s.status_azka }}",
                        {{ s.truck_position | tojson }}
                    )'>
                    <i class="bi bi-geo-alt-fill"></i> Tracking
                </button>
                {% if s.status_azka not in['DELIVERED','READY_FOR_DELIVERY','PICKUP','ARRIVED_AT_HUB','SORTING'] %}

                    {% if not s.driver_id_azka %}
                    <button
                        class="btn btn-success scan-driver-btn"
                        onclick="openDriverScan({{ s.id_azka }}, '{{ s.tracking_number_azka }}')">
                        Scan Driver
                    </button>
                    {% else %}
                    <span class="badge bg-success">Driver Assigned</span>
                    {% endif %}

                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

        </div>

    </div>
    <div class="form-grid">
        <div id="add_product" class="modal-overlay">
        <div class="modal-box">

            <h4>Tambah Shipment (Drop Point)</h4>

            <form action="/shipment_add_azka" method="POST">

                <label class="mt-2">Nama Pengirim</label>
                <input type="text" name="sender_name_azka" class="form-control" required>

                <label class="mt-2">Nama Penerima</label>
                <input type="text" name="receiver_name_azka" class="form-control" required>

                <label class="mt-2">Nama Barang</label>
                <input name="nama_barang_azka" class="form-control" placeholder="Nama Barang" required>
                <label class="mt-2">Berat Barang</label>
                <input name="berat_azka" type="number" step="0.1" class="form-control" placeholder="Berat (kg)" required>

                <label class="mt-2"> Jumlah</label>
                <input name="qty_azka" type="number" class="form-control" placeholder="Qty" required>

                <label class="mt-2">Alamat Penerima</label>
                <textarea name="receiver_address_azka" class="form-control" rows="3" required></textarea>

                <label class="mt-2">Gudang Awal (Drop Point)</label>
                <select name="warehouse_id_azka" class="form-control" required>
                    <option value="">--Pilih Gudang--</option>
                    {% for w in warehouses_azka %}
                    <option value="{{ w.id_azka }}">
                        {{ w.nama_azka }}
                    </option>
                    {% endfor %}
                </select>

                <!-- STATUS DISET OTOMATIS -->
                <input type="hidden" name="status_azka" value="CREATED">

                <div class="d-flex justify-content-end gap-3 mt-4">
                    <a href="#" class="btn btn-secondary">Batal</a>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-box-arrow-up"></i> Buat Shipment
                    </button>
                </div>

            </form>

        </div>
    </div>
</div>
<div class="modal fade" id="driverScanModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      
      <div class="modal-header">
        <h5 class="modal-title">Scan Driver</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <div class="mb-2">
            <strong>No Resi:</strong>
            <span id="scanResi"></span>
        </div>

        <input type="hidden" id="scanShipmentId">

        <!-- INPUT MANUAL -->

        <input 
            type="text" 
            id="driverQR"
            class="form-control mb-3"
            placeholder="Scan QR Driver..."
        >

        <div class="mb-3">
            <label>Upload QR Driver</label>
            <input 
                type="file" 
                id="qrImageInput"
                accept="image/*"
                class="form-control">
        </div>

        <div id="readerDriver"></div>


        <div id="scanResult" class="mt-3"></div>

      </div>

    </div>
  </div>
</div>
<div class="modal fade" id="trackingModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Tracking Shipment</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- ID HARUS trackingMap -->
        <div id="trackingMap" style="height:400px;border-radius:12px"></div>
      </div>
    </div>
  </div>
</div>


<div class="bottom-nav d-md-none">
    <a href="/admin_dashboard_azka"
       class="{% if request.path == '/admin_dashboard_azka' %}active{% endif %}">
        <i class="bi bi-speedometer2"></i>
        <span>Dashboard</span>
    </a>

    <a href="/product_azka"
       class="{% if request.path == '/product_azka' %}active{% endif %}">
        <i class="bi bi-box-seam"></i>
        <span>Barang</span>
    </a>

    <a href="/shipment_azka"
       class="{% if request.path == '/shipment_azka' %}active{% endif %}">
        <i class="bi bi-box-arrow-up"></i>
        <span>Shipment</span>
    </a>

    <a href="#" id="openMenu">
        <i class="bi bi-grid"></i>
        <span>Menu</span>
    </a>
</div>
<script>
function distance(lat1, lng1, lat2, lng2) {
    const R = 6371;
    const dLat = (lat2-lat1) * Math.PI/180;
    const dLng = (lng2-lng1) * Math.PI/180;

    const a =
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1*Math.PI/180) *
        Math.cos(lat2*Math.PI/180) *
        Math.sin(dLng/2) * Math.sin(dLng/2);

    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}
</script>
<script>

let trackingMap = null;
let truckMarker = null;
let routeLine = null;

let animationFrameId = null;
let currentProgress = 0;
let globalCoords = [];
let isAnimating = false;
let shipmentStatusGlobal = null;

/* ================= ICON ================= */

const warehouseIcon = L.icon({
    iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
    iconSize: [32, 32],
    iconAnchor: [16, 32]
});

const hubIcon = L.icon({
    iconUrl: 'https://cdn-icons-png.flaticon.com/512/535/535239.png',
    iconSize: [28, 28],
    iconAnchor: [14, 28]
});

const destinationIcon = L.icon({
    iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684809.png',
    iconSize: [32, 32],
    iconAnchor: [16, 32]
});

const truckIcon = L.icon({
    iconUrl: 'https://cdn-icons-png.flaticon.com/512/3448/3448339.png',
    iconSize: [36, 36],
    iconAnchor: [18, 36]
});


/* ================= OPEN MODAL ================= */

function openTrackingModal(routes, status, truckPosition) {

    const modalEl = document.getElementById('trackingModal');
    const modal = new bootstrap.Modal(modalEl);
    modal.show();

    modalEl.addEventListener('shown.bs.modal', () => {
        renderTrackingMap(routes, status, truckPosition);
        setTimeout(() => {
            if (trackingMap) trackingMap.invalidateSize();
        }, 300);
    }, { once: true });
}


/* ================= RENDER MAP ================= */

function renderTrackingMap(routes, status, truckPosition) {

    if (!routes || routes.length === 0) {
        alert("Data tracking tidak tersedia");
        return;
    }

    if (trackingMap) {
        trackingMap.remove();
        trackingMap = null;
    }

    trackingMap = L.map('trackingMap').setView(
        [routes[0].lat, routes[0].lng],
        6
    );

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap'
    }).addTo(trackingMap);

    let points = [];
    let hubIndex = 1;

    routes.forEach(r => {

        if (!r.lat || !r.lng) return;

        const lat = parseFloat(r.lat);
        const lng = parseFloat(r.lng);

        let icon = warehouseIcon;
        let label = "Gudang Asal";

        if (r.type === "HUB") {
            icon = hubIcon;
            label = `Hub Transit ${hubIndex}`;
            hubIndex++;
        }

        if (r.type === "DESTINATION") {
            icon = destinationIcon;
            label = "Tujuan";
        }

        L.marker([lat, lng], { icon })
            .addTo(trackingMap)
            .bindPopup(`<b>${r.name}</b><br>${label}`);

        points.push([lat, lng]);
    });

    if (points.length > 1) {

        routeLine = L.Routing.control({
            waypoints: points.map(p => L.latLng(p[0], p[1])),
            router: L.Routing.osrmv1({
                serviceUrl: 'https://router.project-osrm.org/route/v1'
            }),
            addWaypoints: false,
            draggableWaypoints: false,
            fitSelectedRoutes: true,
            show: false,
            lineOptions: {
                styles: [{ weight: 5, opacity: 0.8 }]
            },
            createMarker: () => null
        }).addTo(trackingMap);

        if (!truckMarker) {
            truckMarker = L.marker(points[0], { icon: truckIcon }).addTo(trackingMap);
        }

        routeLine.on('routesfound', function (e) {

        globalCoords = e.routes[0].coordinates;
        shipmentStatusGlobal = status;

        // ===== STATUS DIAM =====
        if (status === "CREATED" || status === "PICKUP") {
            currentProgress = 0;
            isAnimating = false;
        }

        else if (
            status === "ARRIVED_AT_ORIGIN_HUB" ||
            status === "SORTING"
        ) {
            currentProgress = Math.floor(globalCoords.length * 0.25);
            isAnimating = false;
        }

        // ===== STATUS BERJALAN =====
        else if (
            status === "IN_TRANSIT" ||
            status === "OUT_FOR_DELIVERY" ||
            status === "ON_THE_WAY"
        ) {
            if (!isAnimating) {
                isAnimating = true;
                animateTruck();
            }
        }

        // ===== STATUS SELESAI =====
        else if (status === "DELIVERED") {
            currentProgress = globalCoords.length - 1;
            isAnimating = false;
        }

        updateTruckPosition();
    });
    }
}


/* ================= ANIMATION ENGINE ================= */
function animateTruck() {

    const speed = 0.0025;

    function step() {

        if (!isAnimating) return;

        currentProgress += speed;

        if (currentProgress >= globalCoords.length - 1) {
            currentProgress = globalCoords.length - 1;
            isAnimating = false;
            updateTruckPosition();
            return;
        }

        updateTruckPosition();
        requestAnimationFrame(step);
    }

    requestAnimationFrame(step);
}

/* ================= UPDATE POSITION ================= */

function updateTruckPosition() {

    if (!truckMarker || globalCoords.length === 0) return;

    const index = Math.floor(currentProgress);
    const nextIndex = index + 1;

    if (nextIndex >= globalCoords.length) return;

    const start = globalCoords[index];
    const end = globalCoords[nextIndex];

    const t = currentProgress - index;

    const lat = start.lat + (end.lat - start.lat) * t;
    const lng = start.lng + (end.lng - start.lng) * t;

    truckMarker.setLatLng([lat, lng]);

    const angle = Math.atan2(
        end.lng - start.lng,
        end.lat - start.lat
    ) * (180 / Math.PI);

    if (truckMarker.setRotationAngle) {
        truckMarker.setRotationAngle(angle);
    }
}


/* ================= MODAL CLOSE ================= */

document.getElementById('trackingModal')
.addEventListener('hidden.bs.modal', function () {

    if (trackingMap) {
        trackingMap.remove();
        trackingMap = null;
    }

    // ANIMASI TETAP BERJALAN DI BACKGROUND
});

</script>
 <script>
        const openMenu = document.getElementById('openMenu');
        const closeMenu = document.getElementById('closeMenu');
        const mobileMenu = document.getElementById('mobileMenu');

        openMenu.addEventListener('click', e => {
            e.preventDefault();
            mobileMenu.classList.add('show');
        });

        closeMenu.addEventListener('click', () => {
            mobileMenu.classList.remove('show');
        });
    </script>
<script>

let driverScanner = null;

function openDriverScan(shipmentId, resi){

    document.getElementById("scanShipmentId").value = shipmentId;
    document.getElementById("scanResi").innerText = resi;

    const modal = new bootstrap.Modal(
        document.getElementById("driverScanModal")
    );

    modal.show();

    setTimeout(()=>{
        startDriverScanner();
    },500);
}


function startDriverScanner(){

    if(driverScanner){
        driverScanner.clear();
    }

    driverScanner = new Html5Qrcode("readerDriver");

    driverScanner.start(
        { facingMode: "environment" },
        {
            fps: 10,
            qrbox: 250
        },
        (decodedText)=>{
            assignDriver(decodedText);
        }
    );
}


function assignDriver(qr){

    let shipmentId =
        document.getElementById("scanShipmentId").value;

    fetch("/admin_scan_driver_assignment_azka",{
        method:"POST",
        headers:{
            "Content-Type":
            "application/x-www-form-urlencoded"
        },
        body:
            "shipment_id="+shipmentId+
            "&driver_qr="+qr
    })
    .then(res=>res.json())
    .then(data=>{

        document.getElementById("scanResult")
        .innerHTML = data.message;

        if(driverScanner){
            driverScanner.stop();
        }

        setTimeout(()=>{
            location.reload();
        },1000);

    });

}


// INPUT MANUAL
document.getElementById("driverQR")
.addEventListener("change", function(){

    assignDriver(this.value);
    this.value = "";

});


// STOP CAMERA SAAT MODAL TUTUP
document.getElementById("driverScanModal")
.addEventListener("hidden.bs.modal", function(){

    if(driverScanner){
        driverScanner.stop();
    }

});

</script>
<script>

// SCAN DARI GAMBAR
document.getElementById("qrImageInput")
.addEventListener("change", function(e){

    const file = e.target.files[0];
    if(!file) return;

    const html5QrCode = new Html5Qrcode("readerDriver");

    html5QrCode.scanFile(file, true)
    .then(decodedText => {

        document.getElementById("scanResult")
        .innerHTML = "QR terbaca: " + decodedText;

        assignDriver(decodedText);

    })
    .catch(err => {

        document.getElementById("scanResult")
        .innerHTML = "QR tidak terbaca";

    });

});
</script>
    <!-- BOOTSTRAP SCRIPT -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet-rotatedmarker/leaflet.rotatedMarker.js"></script>
</body>
</html>
