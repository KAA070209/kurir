<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Gudang ‚Äì Logistics Azka</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="icon" href="/static/icon/icon.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { background:#f8fafc; font-family:'Inter',sans-serif }
        .card-box { background:#fff; border-radius:18px; padding:24px; box-shadow:0 8px 24px rgba(0,0,0,.06) }
        .gradient-text { background:linear-gradient(135deg,#667eea,#764ba2); -webkit-background-clip:text; -webkit-text-fill-color:transparent }
        .city-card { border-radius:16px; box-shadow:0 6px 18px rgba(0,0,0,.05); border:none }
        #reader, #reader-kurir { width:100%; border-radius:16px; overflow:hidden; }
    </style>
</head>
<body>

<div class="container py-4">

    <!-- HEADER -->
    <div class="card-box mb-4 d-flex justify-content-between align-items-center">
        <div>
            <h4 class="mb-0 gradient-text">Dashboard Gudang</h4>
            <small class="text-muted">Scan Paket Masuk Sortir</small>
        </div>
        <a href="/logout_azka" class="btn btn-outline-danger btn-sm">Logout</a>
    </div>

    <!-- HASIL SORTIR PER KOTA -->
    {% if data_per_kota %}
        {% for kota, paket in data_per_kota.items() %}
        <div class="card city-card mb-4">
            <div class="card-header fw-semibold d-flex justify-content-between">
                üìç {{ kota }}
                <span class="badge bg-dark">{{ paket|length }} paket</span>
            </div>
            <div class="card-body p-0">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Resi</th>
                            <th>Penerima</th>
                            <th>Alamat</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in paket %}
                        <tr>
                            <td class="fw-semibold text-primary">{{ p.tracking_number_azka }}</td>
                            <td>{{ p.receiver_name_azka }}</td>
                            <td>{{ p.receiver_address_azka }}</td>
                            <td><span class="badge bg-warning text-dark">{{ p.status_azka }}</span></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="alert alert-info text-center">Belum ada paket dalam proses sortir</div>
    {% endif %}

    <!-- SCAN SORTIR PAKET -->
    <div class="card-box mb-4">
        <h6 class="fw-semibold mb-3">üì¶ Sortir Paket</h6>
        <div id="reader"></div>
        <div id="scan_info" class="mt-3"></div>

        <div class="row g-2 mt-3">
            <div class="col-6">
                <button class="btn btn-success w-100" onclick="startScan()">‚ñ∂ START</button>
            </div>
            <div class="col-6">
                <button class="btn btn-danger w-100" onclick="stopScan()">‚èπ STOP</button>
            </div>
        </div>
    </div>

    <!-- SCAN SERAHKAN KE KURIR -->
    <div class="card-box mb-4">
        <h6 class="fw-semibold mb-3">üöö Serahkan Paket ke Kurir</h6>
        <div class="alert alert-info">1Ô∏è‚É£ Scan QR Kurir <br>2Ô∏è‚É£ Scan QR Paket</div>
        <div id="reader-kurir"></div>
        <div class="row g-2 mt-3">
            <div class="col-6">
                <button class="btn btn-success w-100" onclick="startScanKurir()">‚ñ∂ START</button>
            </div>
            <div class="col-6">
                <button class="btn btn-danger w-100" onclick="stopScanKurir()">‚èπ STOP</button>
            </div>
        </div>
        <div id="scan_kurir_info" class="mt-3"></div>
    </div>

</div>

<footer class="text-center text-muted py-3">Logistics Azka ¬© 2026</footer>

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* =================== SORTIR PAKET =================== */
let html5QrCode, scanning=false, lastScan="", scanned=false;
const info = document.getElementById("scan_info");

function startScan(){
    if(scanning) return;
    scanning=true;
    html5QrCode=new Html5Qrcode("reader");
    html5QrCode.start({facingMode:"environment"},{fps:10,qrbox:250},
        decodedText=>{
            if(decodedText===lastScan) return;
            lastScan=decodedText;
            kirimScan(decodedText);
        }
    );
    info.innerHTML='<div class="alert alert-success">üì∑ Kamera aktif</div>';
}

function stopScan(){
    if(!html5QrCode) return;
    html5QrCode.stop().then(()=>{
        scanning=false;
        lastScan="";
        scanned=false;
        info.innerHTML='<div class="alert alert-secondary">‚èπ Kamera dihentikan</div>';
    });
}

function kirimScan(tracking){
    if(scanned) return;
    scanned=true;
    fetch("/scan_sortir_azka",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tracking_number:tracking})})
    .then(res=>res.json())
    .then(data=>{
        info.innerHTML=`<div class="alert alert-${data.status}">${data.message}</div>`;
        if(data.status==="success") setTimeout(()=>location.reload(),800);
        else scanned=false;
    })
    .catch(()=>{info.innerHTML='<div class="alert alert-danger">‚ùå Gagal scan</div>';scanned=false;});
}

/* =================== SERAHKAN KE KURIR =================== */
let qrKurir=null, qrPaket=null, kurirScanner=null, scanningKurir=false, scannedKurir=false;
const infoKurir=document.getElementById("scan_kurir_info");

function startScanKurir(){
    if(scanningKurir) return;
    scanningKurir=true; qrKurir=null; qrPaket=null; scannedKurir=false;
    kurirScanner=new Html5Qrcode("reader-kurir");
    kurirScanner.start({facingMode:"environment"},{fps:10,qrbox:250},handleScan);
    infoKurir.innerHTML='<div class="alert alert-info">üì∑ Scan QR Identitas Kurir</div>';
}

function stopScanKurir(){
    if(!kurirScanner) return;
    kurirScanner.stop().then(()=>{
        scanningKurir=false; qrKurir=null; qrPaket=null; scannedKurir=false;
        infoKurir.innerHTML='<div class="alert alert-secondary">‚èπ Scan dihentikan</div>';
    });
}

function handleScan(text){
    if(!qrKurir){
        if(!text.startsWith("KURIR|")){infoKurir.innerHTML='<div class="alert alert-danger">‚ùå Scan QR Kurir dulu</div>'; return;}
        qrKurir=text;
        infoKurir.innerHTML='<div class="alert alert-warning">‚úÖ Kurir terdeteksi<br>üì¶ Silakan scan paket</div>';
        return;
    }
    if(!qrPaket){
        if(!text.startsWith("PAKET|")){infoKurir.innerHTML='<div class="alert alert-danger">‚ùå QR ini bukan paket</div>'; return;}
        qrPaket=text;
        kirimKeKurir();
    }
}

function kirimKeKurir(){
    if(scannedKurir) return;
    scannedKurir=true;
    navigator.geolocation.getCurrentPosition(pos=>{
        fetch("/scan_kurir_ready_delivery_azka",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"same-origin",
            body:JSON.stringify({qr_kurir:qrKurir,qr_paket:qrPaket,latitude:pos.coords.latitude,longitude:pos.coords.longitude})
        })
        .then(res=>res.json())
        .then(data=>{
            infoKurir.innerHTML=`<div class="alert alert-${data.status}">${data.message}</div>`;
            if(data.status==="success"){stopScanKurir();setTimeout(()=>location.reload(),1200);}
            else scannedKurir=false;
        })
        .catch(()=>{infoKurir.innerHTML='<div class="alert alert-danger">‚ùå Gagal kirim data</div>';scannedKurir=false;});
    },err=>{infoKurir.innerHTML='<div class="alert alert-danger">‚ùå Tidak bisa mendapatkan lokasi</div>';scannedKurir=false;});
}
</script>
